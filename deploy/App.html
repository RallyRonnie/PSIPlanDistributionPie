<!DOCTYPE html>
<html>
<head>
    <title>Pie Chart</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",scopeType:"release",comboboxConfig:{fieldLabel:"Select an Release:",labelWidth:100,width:300},addContent:function(){this._showMask("Loading Data"),this._makeStore()},_makeStore:function(){Ext.create("Rally.data.WsapiDataStore",{model:"HierarchicalRequirement",autoLoad:!0,fetch:["Name","FormattedID","Release","ObjectID","Feature","PortfolioItem","PlanEstimate"],filters:[this.getContext().getTimeboxScope().getQueryFilter()],listeners:{load:function(store,data){this._countPointsByCategory(data)},scope:this}})},onScopeChange:function(){this._showMask("Loading Data"),this._makeStore()},_countPointsByCategory:function(records){var me=this,counts={},counter=0,total=0;Ext.Array.each(records,function(record){var category="",points=record.get("PlanEstimate")||0;if(null===record.get("Feature"))category="Non-Feature";else{var PIobject=record.get("Feature");category=PIobject.FormattedID}counts[category]||(counts[category]=0),counts[category]+=points,total+=points,counter++});var count_array=[];for(var category in counts)counts.hasOwnProperty(category)&&count_array.push({name:category,count:counts[category],percentage:100*counts[category]/total});this._showPie(count_array)},_showPie:function(count_array){var me=this,int_array=[];Ext.Array.each(count_array,function(item){int_array.push([item.name,item.percentage])});var mystore=Ext.create("Rally.data.custom.Store",{data:count_array});this.chart&&this.chart.destroy(),this.chart=Ext.create("Ext.chart.Chart",{minWidth:400,minHeight:500,store:mystore,theme:"Base:gradients",series:[{type:"pie",allowPointSelect:!1,angleField:"percentage",showInLegend:!0,tips:{trackMouse:!0,width:140,height:50,hideDelay:2e3,renderer:function(storeItem,item){this.setTitle(storeItem.get("name")+": "+Math.round(storeItem.get("percentage"),3)+"%<br>Story Point Count: "+storeItem.get("count"))}},label:{field:"name",display:"rotate",contrast:!0,font:"12px Arial"}}]}),me.add(this.chart),this._hideMask()},_showMask:function(msg){this.getEl()&&(this.getEl().unmask(),this.getEl().mask(msg))},_hideMask:function(){this.getEl().unmask()}});

            Rally.launchApp('CustomApp', {
                name:"Pie Chart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
